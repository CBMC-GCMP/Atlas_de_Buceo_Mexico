---
title: "Atlas de Buceo de México"
resource_files:
- "shp/Diving_sites_v1.0_01032021/dive_sites.shx"
- "shp/Diving_sites_v1.0_01032021/dive_sites.prj"
- "shp/Diving_sites_v1.0_01032021/dive_sites.dbf"
- "shp/Diving_sites_v1.0_01032021/dive_sites.cpg"
- "shp/Tourism_operators_v1.0_01032021/operators.cpg"
- "shp/Tourism_operators_v1.0_01032021/operators.dbf"
- "shp/Tourism_operators_v1.0_01032021/operators.prj"
- "shp/Tourism_operators_v1.0_01032021/operators.qpj"
- "shp/Tourism_operators_v1.0_01032021/operators.shx"
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.shx" 
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.prj" 
- "shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.dbf" 

runtime: shiny
output:
        flexdashboard::flex_dashboard:
        source_code: embed
        theme: united
---
        
Atlas de Buceo de México
=======================================================================
        
```{r setup, include=FALSE}

library(flexdashboard)
library(leaflet)
library(mapview)
library(rgdal)
library(sf)
library(tidyverse)
library(ggthemes)
library(viridis)


# Loading diving site data and diving operators data ----------------

ds <- raster::shapefile("shp/Diving_sites_v1.0_01032021/dive_sites.shp", verbose = FALSE)
to <- raster::shapefile("shp/Tourism_operators_v1.0_01032021/operators.shp", verbose = FALSE)

# Loading MPA layer -------------------
mpa <- raster::shapefile("shp/MPA_MX_v1.0_01032021/MPA_MX_c1-0.shp", encoding = "latin1")

```


```{r}

to$labels1 <- paste0(
  "<h3 style= 'background-color:tomato; color: black; text-align: center; font-size: 130%; font-family:verdana'> Operator </h3>", 
                     "<b style= 'color:red'> Región: </b> ", to$region, "<br/> ",
                     "<b style= 'color:red'> Estado: </b> ", to$state, "<br/> ",
                     "<b style= 'color:red'> Nombre: </b> ", to$company_na, "<br/> ",
                     "<b style= 'color:red'> Latitud: </b> ", to$lat, "<br/> ",
                     "<b style= 'color:red'> Longitud: </b> ", to$LONG, "<br/> ",
                     "<b style= 'color:red'> Dirección: </b> ", to$long, "<br/> ",
                     "<b style= 'color:red'> Telefono: </b> ", to$phone, "<br/> ",
                     "<b style= 'color:red'> Correo: </b> ", to$email, "<br/> ") %>%
        lapply(htmltools::HTML)

ds$labels2 <- paste0(
  "<h3 style= 'background-color:powderblue; color: black; text-align: center; font-size: 130%; font-family:verdana'> Diving Site </h3>", 
                     "<b style= 'color:red'> Nombre: </b> ", ds$site_name, "<br/> ",
                     "<b style= 'color:red'> Región: </b> ", ds$region, "<br/> ",
                     "<b style= 'color:red'> Localidad: </b> ", ds$locality, "<br/> ",
                     "<b style= 'color:red'> Estado: </b> ", ds$state, "<br/> ",
                     "<b style= 'color:red'> Popularidad: </b> ", ds$popularity, "<br/> ",
                     "<b style= 'color:red'> Latitud: </b> ", ds$latitude, "<br/> ",
                     "<b style= 'color:red'> Longitud: </b> ", ds$longitude, "<br/> ") %>%
        lapply(htmltools::HTML)


mpa$labels3 <- paste0("<style> div.leaflet-popup-content {width:auto !important;}</style>",
  "<h3 style= 'background-color:#14c794; color: black; text-align: center; font-size: 130%; font-family:verdana'> AMP </h3>", 
                      "<b style= 'color:red'> Nombre: </b> ", mpa$ANP, "<br/> ",
                      "<b style= 'color:red'>Plan de Manejo: </b> ", mpa$PM_link, "<br/> ",
                      "<b style= 'color:red'>Fecha: </b> ", mpa$FECHA, "<br/> ",
                      "<b style= 'color:red'> Zona: </b> ", mpa$Categor, "<br/> ",
                      "<b style= 'color:red'> Subzona </b> ", mpa$Subznfc, "<br/> ",
                      "<b style= 'color:red'> Buceo: </b> ", mpa$Buceo, "<br/> ",
                      "<b style= 'color:red'> Pesca: </b> ", mpa$Pesca, "<br/> ") %>%
        lapply(htmltools::HTML)

#Create a diving flag as marker
diverIcon <- makeIcon(
  iconUrl = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/ICS_Diver.svg/280px-ICS_Diver.svg.png",
  iconWidth = 20, iconHeight = 20,
  iconAnchorX = 0, iconAnchorY = 0 
)

icons <- awesomeIcons(
        icon = 'flag-outline',
        iconColor = 'black',
        library = 'ion')


leaflet(to) %>%
        addProviderTiles(providers$Esri.WorldImagery, group = "Satélite") %>%
        addProviderTiles(providers$Esri.WorldTopoMap, group = "Mapa") %>%
        addProviderTiles(providers$Esri.OceanBasemap, group = "Ocean") %>%

        setView(lng = -108, lat = 25, zoom = 2) %>%
        addAwesomeMarkers(
                popup = ~ labels1,
                group = "Operators",
                icon = awesomeIcons(icon = "home",
                                    markerColor = "darkred",
                                    library = "ion")
        ) %>%
        addPolygons(
                data = mpa,
                group = "AMPs",
                weight = 2,
                opacity = 1,

                fillColor = "magma",
                fillOpacity = 0.3,
                color = "#bf0a0a",
                dashArray = "2",
                highlightOptions = highlightOptions(
                        color = "#06d611",
                        weight = 2,
                        bringToFront = TRUE
                ),
                popup = ~ labels3 
        ) %>%
        addMarkers(
                icon=diverIcon,#Add diving flag as marker
                clusterOptions = markerClusterOptions(),
                data = ds, 
                group = "Diving sites",
                popup = ~ labels2
        ) %>% 
        # Layers control
        addLayersControl(
                baseGroups = c("Satélite", "Mapa", "Ocean"),
                overlayGroups = c("Operators", "AMPs", "Diving sites"),
                options = layersControlOptions(collapsed = TRUE)
        ) %>%
        hideGroup(c("Operators", "Diving sites")) %>%
        setView(lng = -99.1332,
                lat = 19.4326,
                zoom = 4) %>% 
#addProviderTiles(providers$Esri.WorldStreetMap) %>%
  addMiniMap()


```




Credits
=======================================================================
        
### About the project

This work is part of the diving atlas initiative in Mexico, a project where international institutions are collaborating: the Scripps Institution of Oceanography (USA), the Gulf of California Marina Program (USA), the Centro para la Biodiversidad Marina y la Conservación, A.C. (México), the Universidad Autónoma de Baja California Sur (México), the Senckenberg Institute (Germany). 

### Data sources

- Mexican MPA layer is currently under development, original data from: http://sig.conanp.gob.mx/website/pagsig/info_shape.htm


### Dashboard, data creation and supervision: 

- Dr. Fabio Favoretto (UABCS-CBMC);

### Data creation:

- Joy Kumagai (Senckenberg);
- Terrance Wang (NOAA);
- Norman Blanco Lupio (CBMC);
- Eduardo León Solórzano (UABCS);
- Eduardo Peláez Torres (UABCS);

### Project supervision: 

- Marisol Placencia de la Cruz (CBMC); 
- Octavio Aburto Oropeza (SIO); 
- Catalina López Sagastégui (UC-Mexus);

